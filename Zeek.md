### Configuring Zeek
---
First off, we need to install zeek  
`sudo yum install zeek zeek-plugin-kafka zeek-plugin-af_packet`  

General changes to your networks can be made in the below file. We don't need to make any changes to this file.  
`vi /etc/zeek/networks.cfg`
```
# List of local networks in CIDR notation, optionally followed by a
# descriptive tag.
# For example, "10.0.0.0/8" or "fe80::/64" are valid prefixes.

10.0.0.0/8          Private IP space
172.16.0.0/12       Private IP space
192.168.0.0/16      Private IP space
```
Make the following changes to the zeek config file.  
`sudo vi /etc/zeek/zeekctl.cfg`  
```
                                        + + +
67 LogDir = /data/zeek
                                        + + +
76 lb_custom.InterfacePrefix=af_packet::
```

Up next, we make the following changes to the node file.  
`sudo vi /etc/zeek/node.cfg`  
```
 8 #[zeek]                                        + + +
 9 #type=standalone
10 #host=localhost
11 #interface=eth0
                                        + + +
16 [logger]
17 type=logger
18 host=localhost
                                        + + +
20 [manager]
21 type=manager
22 host=localhost
23 pin_cpus=1
                                        + + +
25 [proxy-1]
26 type=proxy
27 host=localhost
                                        + + +
29 [worker-1]
30 type=worker
31 host=localhost
32 interface=enp5s0
33 lb_method=custom
34 lb_procs=2
35 pin_cpus=2,3
36 env_vars=fanout_id=77
                                        + + +
```

Now we set up our scripts.  
`sudo mkdir /usr/share/zeek/site/scripts`  
`cd /usr/share/zeek/site/scripts/`  
`sudo curl -LO 192.168.2.20:8080/zeek_scripts/afpacket.zeek`  
```
[admin@SG-30 scripts]$ cat afpacket.zeek
redef AF_Packet::fanout_id = strcmp(getenv("fanout_id"),"") == 0 ? 0 : to_count(getenv("fanout_id"));
```
Now we install our Zeek extension. No changes needed to the file, just verify it looks like below.  
`sudo curl -LO 192.168.2.20:8080/zeek_scripts/extension.zeek`  
```
1 type Extension: record {
2     ## The log stream that this log was written to.
3     stream:   string &log;
4     ## The name of the system that wrote this log. This
5     ## is defined in the  const so that
6     ## a system running lots of processes can give the
7     ## same value for any process that writes a log.
8     system:   string &log;
9     ## The name of the process that wrote the log. In
10     ## clusters, this will typically be the name of the
11     ## worker that wrote the log.
12     proc:     string &log;
13 };
14
15 function add_log_extension(path: string): Extension
16 {
17     return Extension($stream = path,
18                         $system = "sensor1",
19                         $proc   = peer_description);
20 }
21
22 redef Log::default_ext_func   = add_log_extension;
23 redef Log::default_ext_prefix = "@";
24 redef Log::default_scope_sep  = "_";
```

We must ensure that Zeek loads the scripts we've just created by adding the following lines at the bottom of the below file.
`sudo vi /usr/share/zeek/site/local.zeek`  
```
                                        + + +
104 @load /usr/share/zeek/site/scripts/afpacket.zeek
105 @load /usr/share/zeek/site/scripts/extension.zeek
```

Don't forget to change the ownership! We've got lots of files with this service.  
`sudo chown -R zeek: /etc/zeek`  
`sudo chown -R zeek: /data/zeek`  
`sudo chown -R zeek: /usr/bin/zeek`  
`sudo chown -R zeek: /usr/share/zeek`  
`sudo chown -R zeek: /usr/bin/capstats`  
`sudo chown -R zeek: /var/spool/zeek`  

Now we edit permissions so Zeek is able to do everything it needs to.  
`sudo /sbin/setcap cap_net_raw,cap_net_admin=eip /usr/bin/zeek`  
`sudo /sbin/setcap cap_net_raw,cap_net_admin-eip /usr/bin/capstats`  

Verify that these changes took:  
```
[admin@SG-30 scripts]$ sudo getcap /usr/bin/zeek
/usr/bin/zeek = cap_net_admin,cap_net_raw+eip
[admin@SG-30 scripts]$ sudo getcap /usr/bin/capstats
/usr/bin/capstats = cap_net_admin,cap_net_raw+eip
```

Create a new file for the zeek service. This allows us to use commands like systemctl to interface with the service.   
`sudo vi /etc/systemd/system/zeek.service`  
```
[Unit]
Description=Zeek Network Analysis Engine
After=network.target

[Service]
Type=forking
User=zeek
ExecStart=/usr/bin/zeekctl deploy
ExecStop=/usr/bin/zeetctl stop

[Install]
WantedBy=multi-user.target
```

Reload the daemon so that this new service goes into effect.  
`sudo systemctl daemon-reload`  

Now we can start zeek to hopefully no errors.  
`sudo systemctl start zeek`  
`sudo systemctl enable zeek`  
`sudo systemctl status zeek`  

Verify logs are being generated by checking the below directory  
`sudo cd /data/zeek/current`
```
[admin@SG-30 current]$ ll
total 68
-rw-r--r--. 1 zeek zeek  1622 Mar 30 14:20 broker.log
-rw-r--r--. 1 zeek zeek   412 Mar 30 14:35 capture_loss.log
-rw-r--r--. 1 zeek zeek  1999 Mar 30 14:20 cluster.log
-rw-r--r--. 1 zeek zeek   664 Mar 30 14:29 conn.log
-rw-r--r--. 1 zeek zeek 37017 Mar 30 14:20 loaded_scripts.log
-rw-r--r--. 1 zeek zeek   230 Mar 30 14:20 packet_filter.log
-rw-r--r--. 1 zeek zeek  3577 Mar 30 14:45 stats.log
-rw-r--r--. 1 zeek zeek     0 Mar 30 14:20 stderr.log
-rw-r--r--. 1 zeek zeek   188 Mar 30 14:20 stdout.log
```
